<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebKonnect</title>
  <style>
    body, html { margin: 0; padding: 0; font-family: sans-serif; background: #f5f5f5; }
    input, button, select, textarea { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #sidebar { display: flex; background: #222; color: white; position: sticky; top: 0; justify-content: space-around; }
    #sidebar button { background: none; border: none; color: white; padding: 10px; flex: 1; }
    .hidden { display: none; }
    .page { padding: 10px; }
    .contact { background: #ddd; padding: 8px; margin: 5px 0; cursor: pointer; border-radius: 6px; }
    .message { max-width: 70%; padding: 8px; margin: 4px 0; border-radius: 5px; word-wrap: break-word; }
    .sent { background: #cce5ff; align-self: flex-end; text-align: right; }
    .received { background: #eee; align-self: flex-start; text-align: left; }
    .photo-img { max-width: 200px; margin: 10px 0; border-radius: 8px; }
    #chat-box { max-height: 200px; overflow-y: auto; background: white; padding: 10px; margin: 10px 0; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEQ1o2xDKKYmvxcXTixwCUmfsiGo2qUpk",
      authDomain: "webkonnect-6db38.firebaseapp.com",
      databaseURL: "https://webkonnect-6db38-default-rtdb.firebaseio.com",
      projectId: "webkonnect-6db38",
      storageBucket: "webkonnect-6db38.firebasestorage.app",
      messagingSenderId: "496108261938",
      appId: "1:496108261938:web:b7c66a94448fefa3dba22b",
      measurementId: "G-9NMKXXPXW5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null, allUsers = [], contacts = [], chatWith = null, cameraStream = null;

    const $ = id => document.getElementById(id);

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        $('#login-screen').classList.add('hidden');
        $('#app-screen').classList.remove('hidden');
        await loadAllUsers();
        await loadContacts();
        showPage('feed');
        initCamera();
        loadWorldFeed();
        initPhotoRecipients();
      } else {
        $('#login-screen').classList.remove('hidden');
        $('#app-screen').classList.add('hidden');
      }
    });

    window.signup = async function() {
      const uname = $('signup-username').value.trim();
      const email = $('signup-email').value.trim();
      const pass = $('signup-password').value;
      if (!uname || !email || !pass) return alert('Fill all fields');
      const unameRef = ref(db, 'usernames/' + uname);
      const unameSnap = await get(unameRef);
      if (unameSnap.exists()) return alert('Username taken');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        currentUser = cred.user;
        await set(ref(db, `users/${currentUser.uid}`), { username: uname, email });
        await set(unameRef, currentUser.uid);
      } catch (e) {
        alert('Signup error: ' + e.message);
      }
    }

    window.login = async function() {
      const uname = $('login-username').value.trim();
      const pass = $('login-password').value;
      const unameSnap = await get(ref(db, 'usernames/' + uname));
      if (!unameSnap.exists()) return alert('No such user');
      const uid = unameSnap.val();
      const userSnap = await get(ref(db, 'users/' + uid));
      const email = userSnap.val()?.email;
      if (!email) return alert('Profile error');
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        currentUser = cred.user;
      } catch (e) {
        alert('Login error: ' + e.message);
      }
    }

    window.logout = () => signOut(auth);

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      $(id + '-page').classList.remove('hidden');
    }

    async function loadAllUsers() {
      const snap = await get(ref(db, 'users'));
      const val = snap.val() || {};
      allUsers = Object.entries(val).map(([uid,u]) => ({ uid, username: u.username }));
      renderSearch('');
    }

    function renderSearch(q) {
      const ul = $('search-results');
      ul.innerHTML = '';
      allUsers.filter(u => u.username.includes(q) && u.uid !== currentUser.uid && !contacts.includes(u.uid))
        .forEach(u => {
          const li = document.createElement('li');
          li.textContent = u.username; li.className='contact';
          li.onclick = () => addContact(u.uid);
          ul.appendChild(li);
        });
    }

    window.searchUsers = () => renderSearch($('user-search').value.trim());

    async function loadContacts() {
      const snap = await get(ref(db, `users/${currentUser.uid}/contacts`));
      contacts = snap.exists() ? Object.keys(snap.val()) : [];
      renderContacts();
    }

    function renderContacts() {
      const ul = $('contact-list');
      ul.innerHTML = '';
      contacts.forEach(uid => {
        const u = allUsers.find(x=>x.uid===uid);
        if (!u) return;
        const li = document.createElement('li');
        li.textContent = u.username;
        li.className = 'contact';
        li.onclick = () => openChat(uid);
        ul.appendChild(li);
      });
    }

    async function addContact(uid) {
      if (contacts.includes(uid)) return alert('Already a contact');
      await update(ref(db, `users/${currentUser.uid}/contacts/${uid}`), true);
      contacts.push(uid);
      renderContacts();
    }

    function openChat(uid) {
      chatWith = uid;
      $('chat-with').textContent = 'Chat with ' + (allUsers.find(u=>u.uid===uid)?.username || 'User');
      showPage('chat');
      loadMessages();
    }

    async function loadMessages() {
      if (!chatWith) return;
      const chatKey = [currentUser.uid, chatWith].sort().join('_');
      const snap = await get(ref(db, 'chats/' + chatKey));
      const msgs = snap.val() || [];
      const box = $('chat-box');
      box.innerHTML = '';
      msgs.forEach(m => {
        const div = document.createElement('div');
        div.textContent = m.text;
        div.className = 'message ' + (m.sender === currentUser.uid ? 'sent' : 'received');
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    }

    window.sendMessage = async function() {
      const text = $('chat-input').value.trim();
      if (!text || !chatWith) return;
      const key = [currentUser.uid,chatWith].sort().join('_');
      const snap = await get(ref(db, 'chats/' + key));
      const msgs = snap.val() || [];
      msgs.push({ sender: currentUser.uid, text, timestamp: Date.now() });
      await set(ref(db, 'chats/' + key), msgs);
      $('chat-input').value = '';
      loadMessages();
    }

    async function loadWorldFeed() {
      const snap = await get(ref(db, 'world_feed'));
      const arr = snap.val() || [];
      const el = $('world-feed');
      el.innerHTML = '';
      arr.forEach(p => {
        const d = document.createElement('div');
        d.textContent = `${p.username}: ${p.text}`;
        d.style.background = '#eee';
        d.style.margin = '8px';
        d.style.padding = '6px';
        d.style.borderRadius = '6px';
        el.appendChild(d);
      });
    }

    window.postWorld = async function() {
      const text = $('world-post').value.trim();
      if (!text) return alert('Enter something');
      const snap = await get(ref(db, 'world_feed'));
      const arr = snap.val() || [];
      const uname = allUsers.find(u => u.uid === currentUser.uid)?.username || 'Anonymous';
      arr.unshift({ username: uname, text, timestamp: Date.now() });
      await set(ref(db, 'world_feed'), arr);
      $('world-post').value = '';
      loadWorldFeed();
    }

    async function initCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        $('camera').srcObject = cameraStream;
      } catch (e) {
        alert('Camera fail: ' + e.message);
      }
    }

    function initPhotoRecipients() {
      const sel = $('photo-recipient');
      sel.innerHTML = '';
      allUsers.forEach(u => {
        if (u.uid === currentUser.uid) return;
        const o = document.createElement('option');
        o.value = u.uid;
        o.textContent = u.username;
        sel.appendChild(o);
      });
    }

    window.takePhoto = async function() {
      if (!cameraStream) return alert('Camera not ready');
      const video = $('camera');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      const txt = $('photo-text').value.trim();
      if (txt) {
        ctx.font = '24px Arial';
        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.strokeText(txt, canvas.width/2, canvas.height - 30);
        ctx.fillText(txt, canvas.width/2, canvas.height - 30);
      }
      const data = canvas.toDataURL('image/png');
      const to = $('photo-recipient').value;
      const snap = await get(ref(db, `photochat/${to}/${currentUser.uid}`));
      const arr = snap.val() || [];
      arr.unshift({ from: currentUser.uid, photo: data, text: txt, timestamp: Date.now() });
      await set(ref(db, `photochat/${to}/${currentUser.uid}`), arr);
      $('photo-text').value = '';
    }
  </script>
</head>
<body>

<div id="login-screen">
  <h2>WebKonnect</h2>
  <input id="login-username" placeholder="Username">
  <input type="password" id="login-password" placeholder="Password">
  <button onclick="login()">Login</button>
  <hr>
  <input id="signup-username" placeholder="New Username">
  <input type="email" id="signup-email" placeholder="Email">
  <input type="password" id="signup-password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
</div>

<div id="app-screen" class="hidden">
  <div id="sidebar">
    <button onclick="showPage('feed')">🌍</button>
    <button onclick="showPage('contacts')">👥</button>
    <button onclick="showPage('chat')">💬</button>
    <button onclick="showPage('photo')">📸</button>
    <button onclick="logout()">🚪</button>
  </div>
  <div class="page" id="feed-page">
    <textarea id="world-post" placeholder="Post something..."></textarea>
    <button onclick="postWorld()">Post</button>
    <div id="world-feed"></div>
  </div>
  <div class="page hidden" id="contacts-page">
    <input id="user-search" placeholder="Search users..." oninput="searchUsers()">
    <ul id="search-results"></ul>
    <h4>Your Contacts:</h4>
    <ul id="contact-list"></ul>
  </div>
  <div class="page hidden" id="chat-page">
    <h3 id="chat-with">Chat</h3>
    <div id="chat-box"></div>
    <input id="chat-input" placeholder="Type message...">
    <button onclick="sendMessage()">Send</button>
  </div>
  <div class="page hidden" id="photo-page">
    <select id="photo-recipient"></select>
    <video id="camera" autoplay playsinline style="width:100%"></video>
    <input id="photo-text" placeholder="Add text...">
    <button onclick="takePhoto()">Capture & Send</button>
  </div>
</div>

</body>
</html>
